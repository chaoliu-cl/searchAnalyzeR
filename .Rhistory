paste(xml_text(abstract_nodes), collapse = " ")
} else {
"No abstract available"
}
# Extract journal
journal_node <- xml_find_first(article, ".//Journal/Title")
journal <- if (!is.na(journal_node)) xml_text(journal_node) else "Unknown journal"
# Extract publication date
year_node <- xml_find_first(article, ".//PubDate/Year")
month_node <- xml_find_first(article, ".//PubDate/Month")
day_node <- xml_find_first(article, ".//PubDate/Day")
year <- if (!is.na(year_node)) xml_text(year_node) else format(Sys.Date(), "%Y")
month <- if (!is.na(month_node)) xml_text(month_node) else "01"
day <- if (!is.na(day_node)) xml_text(day_node) else "01"
# Convert month name to number if necessary
if (nchar(month) > 2) {
month <- match(month, month.name)
if (is.na(month)) month <- "01"
}
# Create date
pub_date <- tryCatch({
as.Date(paste(year, sprintf("%02d", as.numeric(month)), sprintf("%02d", as.numeric(day)), sep = "-"))
}, error = function(e) {
as.Date(paste(year, "01", "01", sep = "-"))
})
# Extract authors
author_nodes <- xml_find_all(article, ".//Author/LastName")
authors <- if (length(author_nodes) > 0) {
paste(xml_text(author_nodes), collapse = ", ")
} else {
"No authors listed"
}
# Extract DOI
doi_node <- xml_find_first(article, ".//ELocationID[@EIdType='doi']")
doi <- if (!is.na(doi_node)) xml_text(doi_node) else NA
data.frame(
id = paste0("PMID:", pmid),
title = title,
abstract = abstract,
source = journal,
date = pub_date,
authors = authors,
doi = doi,
pmid = pmid,
search_source = "PubMed_API",
stringsAsFactors = FALSE
)
})
all_articles <- c(all_articles, batch_data)
# Be respectful to NCBI servers
Sys.sleep(0.5)
}
# Combine all results
do.call(rbind, all_articles)
}
# Execute searches for both strategies
cat("=== EXECUTING STRATEGY A: Clinical Terminology ===\n")
results_A <- search_pubmed_real(
search_terms = strategy_A$terms,
max_results = 150,
date_range = strategy_A$date_range
)
cat("Description:", strategy_A$description, "\n\n")
cat("Strategy B (Patient/Symptom-Focused):\n")
cat("Terms:", paste(strategy_B$terms, collapse = " OR "), "\n")
cat("Description:", strategy_B$description, "\n\n")
# Function to search PubMed and retrieve real articles (same as original)
search_pubmed_real <- function(search_terms, max_results = 200, date_range = NULL) {
# Build PubMed query
query_terms <- paste(paste0('"', search_terms, '"[Title/Abstract]'), collapse = " OR ")
if (!is.null(date_range)) {
date_filter <- paste0('("', format(date_range[1], "%Y/%m/%d"), '"[Date - Publication] : "',
format(date_range[2], "%Y/%m/%d"), '"[Date - Publication])')
full_query <- paste("(", query_terms, ") AND", date_filter, "AND English[Language]")
} else {
full_query <- paste("(", query_terms, ") AND English[Language]")
}
cat("PubMed Query:", full_query, "\n")
# Search PubMed
search_results <- entrez_search(
db = "pubmed",
term = full_query,
retmax = max_results,
use_history = TRUE
)
cat("Found", length(search_results$ids), "articles\n")
if (length(search_results$ids) == 0) {
return(data.frame())
}
# Retrieve detailed information in batches
batch_size <- 50
all_articles <- list()
for (i in seq(1, length(search_results$ids), batch_size)) {
end_idx <- min(i + batch_size - 1, length(search_results$ids))
batch_ids <- search_results$ids[i:end_idx]
cat("Retrieving batch", ceiling(i/batch_size), "of", ceiling(length(search_results$ids)/batch_size), "\n")
# Get abstracts and metadata
abstracts <- entrez_fetch(
db = "pubmed",
id = batch_ids,
rettype = "abstract",
retmode = "xml"
)
# Parse XML
xml_doc <- read_xml(abstracts)
articles <- xml_find_all(xml_doc, ".//PubmedArticle")
batch_data <- lapply(articles, function(article) {
# Extract PMID
pmid_node <- xml_find_first(article, ".//PMID")
pmid <- if (!is.na(pmid_node)) xml_text(pmid_node) else NA
# Extract title
title_node <- xml_find_first(article, ".//ArticleTitle")
title <- if (!is.na(title_node)) xml_text(title_node) else "No title available"
# Extract abstract
abstract_nodes <- xml_find_all(article, ".//AbstractText")
abstract <- if (length(abstract_nodes) > 0) {
paste(xml_text(abstract_nodes), collapse = " ")
} else {
"No abstract available"
}
# Extract journal
journal_node <- xml_find_first(article, ".//Journal/Title")
journal <- if (!is.na(journal_node)) xml_text(journal_node) else "Unknown journal"
# Extract publication date
year_node <- xml_find_first(article, ".//PubDate/Year")
month_node <- xml_find_first(article, ".//PubDate/Month")
day_node <- xml_find_first(article, ".//PubDate/Day")
year <- if (!is.na(year_node)) xml_text(year_node) else format(Sys.Date(), "%Y")
month <- if (!is.na(month_node)) xml_text(month_node) else "01"
day <- if (!is.na(day_node)) xml_text(day_node) else "01"
# Convert month name to number if necessary
if (nchar(month) > 2) {
month <- match(month, month.name)
if (is.na(month)) month <- "01"
}
# Create date
pub_date <- tryCatch({
as.Date(paste(year, sprintf("%02d", as.numeric(month)), sprintf("%02d", as.numeric(day)), sep = "-"))
}, error = function(e) {
as.Date(paste(year, "01", "01", sep = "-"))
})
# Extract authors
author_nodes <- xml_find_all(article, ".//Author/LastName")
authors <- if (length(author_nodes) > 0) {
paste(xml_text(author_nodes), collapse = ", ")
} else {
"No authors listed"
}
# Extract DOI
doi_node <- xml_find_first(article, ".//ELocationID[@EIdType='doi']")
doi <- if (!is.na(doi_node)) xml_text(doi_node) else NA
data.frame(
id = paste0("PMID:", pmid),
title = title,
abstract = abstract,
source = journal,
date = pub_date,
authors = authors,
doi = doi,
pmid = pmid,
search_source = "PubMed_API",
stringsAsFactors = FALSE
)
})
all_articles <- c(all_articles, batch_data)
# Be respectful to NCBI servers
Sys.sleep(0.5)
}
# Combine all results
do.call(rbind, all_articles)
}
# Execute searches for both strategies
cat("=== EXECUTING STRATEGY A: Clinical Terminology ===\n")
results_A <- search_pubmed_real(
search_terms = strategy_A$terms,
max_results = 150,
date_range = strategy_A$date_range
)
cat("\nStrategy A completed. Retrieved", nrow(results_A), "articles.\n\n")
cat("=== EXECUTING STRATEGY B: Patient/Symptom-Focused ===\n")
results_B <- search_pubmed_real(
search_terms = strategy_B$terms,
max_results = 150,
date_range = strategy_B$date_range
)
cat("\nStrategy B completed. Retrieved", nrow(results_B), "articles.\n\n")
# Standardize both result sets
cat("Standardizing search results...\n")
standardized_A <- std_search_results(results_A, source_format = "pubmed")
standardized_B <- std_search_results(results_B, source_format = "pubmed")
# Add strategy identifiers
standardized_A$strategy <- "Clinical_Terminology"
standardized_B$strategy <- "Patient_Symptom_Focused"
# Detect duplicates within each strategy
dedup_A <- detect_dupes(standardized_A, method = "exact")
dedup_B <- detect_dupes(standardized_B, method = "exact")
cat("Strategy A - Total:", nrow(dedup_A), "Unique:", sum(!dedup_A$duplicate), "Duplicates:", sum(dedup_A$duplicate), "\n")
cat("Strategy B - Total:", nrow(dedup_B), "Unique:", sum(!dedup_B$duplicate), "Duplicates:", sum(dedup_B$duplicate), "\n\n")
# Create combined gold standard for comparison
# In practice, this would be your known relevant articles
# Here we'll create a more sophisticated gold standard based on high-confidence matches
cat("Creating enhanced gold standard...\n")
# High-confidence terms that indicate long COVID relevance
high_confidence_patterns <- c(
"long covid", "post-covid", "post-acute covid", "persistent covid",
"covid sequelae", "long haul", "chronic covid", "post covid syndrome"
)
# Articles that appear in both strategies (high confidence)
overlap_ids <- intersect(dedup_A$id[!dedup_A$duplicate], dedup_B$id[!dedup_B$duplicate])
# Articles with multiple high-confidence patterns in title
multi_pattern_A <- dedup_A[!dedup_A$duplicate, ] %>%
filter(rowSums(sapply(high_confidence_patterns, function(p) grepl(p, tolower(title)))) >= 2) %>%
pull(id)
multi_pattern_B <- dedup_B[!dedup_B$duplicate, ] %>%
filter(rowSums(sapply(high_confidence_patterns, function(p) grepl(p, tolower(title)))) >= 2) %>%
pull(id)
# Combine for gold standard
gold_standard_ids <- unique(c(overlap_ids, multi_pattern_A, multi_pattern_B))
cat("Gold standard created with", length(gold_standard_ids), "high-confidence relevant articles\n")
cat("- Overlap between strategies:", length(overlap_ids), "articles\n")
cat("- Strategy A multi-pattern matches:", length(multi_pattern_A), "articles\n")
cat("- Strategy B multi-pattern matches:", length(multi_pattern_B), "articles\n\n")
# Initialize analyzers for both strategies
cat("Initializing SearchAnalyzers for comparison...\n")
analyzer_A <- SearchAnalyzer$new(
search_results = filter(dedup_A, !duplicate),
gold_standard = gold_standard_ids,
search_strategy = strategy_A
)
analyzer_B <- SearchAnalyzer$new(
search_results = filter(dedup_B, !duplicate),
gold_standard = gold_standard_ids,
search_strategy = strategy_B
)
# Calculate comprehensive metrics for both strategies
cat("Calculating performance metrics...\n")
metrics_A <- analyzer_A$calculate_metrics()
metrics_B <- analyzer_B$calculate_metrics()
# Compare strategies using the comparison framework
cat("Performing statistical comparison...\n")
unique_A_ids <- filter(dedup_A, !duplicate)$id
unique_B_ids <- filter(dedup_B, !duplicate)$id
comparison_result <- compare_strategies(
strategy1_results = unique_A_ids,
strategy2_results = unique_B_ids,
gold_standard = gold_standard_ids,
test_type = "mcnemar"
)
# Display comprehensive comparison results
cat("\n=== COMPREHENSIVE STRATEGY COMPARISON RESULTS ===\n\n")
cat("STRATEGY A (Clinical Terminology) PERFORMANCE:\n")
cat("Total Articles Retrieved:", nrow(filter(dedup_A, !duplicate)), "\n")
if (!is.null(metrics_A$precision_recall$precision)) {
cat("Precision:", round(metrics_A$precision_recall$precision, 3), "\n")
cat("Recall:", round(metrics_A$precision_recall$recall, 3), "\n")
cat("F1 Score:", round(metrics_A$precision_recall$f1_score, 3), "\n")
cat("Number Needed to Read:", round(metrics_A$precision_recall$number_needed_to_read, 1), "\n")
}
cat("\nSTRATEGY B (Patient/Symptom-Focused) PERFORMANCE:\n")
cat("Total Articles Retrieved:", nrow(filter(dedup_B, !duplicate)), "\n")
if (!is.null(metrics_B$precision_recall$precision)) {
cat("Precision:", round(metrics_B$precision_recall$precision, 3), "\n")
cat("Recall:", round(metrics_B$precision_recall$recall, 3), "\n")
cat("F1 Score:", round(metrics_B$precision_recall$f1_score, 3), "\n")
cat("Number Needed to Read:", round(metrics_B$precision_recall$number_needed_to_read, 1), "\n")
}
cat("\nSTATISTICAL COMPARISON RESULTS:\n")
cat("Test Used:", comparison_result$test, "\n")
cat("P-value:", round(comparison_result$p_value, 4), "\n")
cat("Statistically Significant:", comparison_result$significant, "\n")
if (!is.null(comparison_result$difference)) {
cat("\nPERFORMANCE DIFFERENCES (B - A):\n")
cat("Precision Difference:", round(comparison_result$difference$precision_diff, 3), "\n")
cat("Recall Difference:", round(comparison_result$difference$recall_diff, 3), "\n")
cat("F1 Score Difference:", round(comparison_result$difference$f1_diff, 3), "\n")
}
# Analyze overlap and unique contributions
cat("\nOVERLAP ANALYSIS:\n")
total_unique_combined <- length(union(unique_A_ids, unique_B_ids))
overlap_count <- length(intersect(unique_A_ids, unique_B_ids))
unique_to_A <- length(setdiff(unique_A_ids, unique_B_ids))
unique_to_B <- length(setdiff(unique_B_ids, unique_A_ids))
cat("Total Unique Articles (Combined):", total_unique_combined, "\n")
cat("Overlap Between Strategies:", overlap_count, "\n")
cat("Unique to Strategy A:", unique_to_A, "\n")
cat("Unique to Strategy B:", unique_to_B, "\n")
cat("Overlap Percentage:", round((overlap_count / total_unique_combined) * 100, 1), "%\n")
# Create enhanced visualizations for comparison
cat("\nGenerating comparative visualizations...\n")
# 1. Side-by-side performance overview
overview_A <- analyzer_A$visualize_performance("overview") +
ggtitle("Strategy A: Clinical Terminology") +
theme(plot.title = element_text(size = 12))
overview_B <- analyzer_B$visualize_performance("overview") +
ggtitle("Strategy B: Patient/Symptom-Focused") +
theme(plot.title = element_text(size = 12))
combined_overview <- overview_A + overview_B +
plot_annotation(title = "Search Strategy Performance Comparison",
subtitle = "Long COVID Search Strategies")
print(combined_overview)
# 2. Temporal comparison
temporal_A <- analyzer_A$visualize_performance("temporal") +
ggtitle("Strategy A: Temporal Distribution") +
theme(plot.title = element_text(size = 12))
pubmed <- PubMedConnector$new()
search_data <- data.frame(
id = paste0("art", 1:100),
title = paste("Article", 1:100),
abstract = paste("Abstract for article", 1:100),
source = "PubMed",
date = Sys.Date() - sample(1:365, 100, replace = TRUE)
)
gold_standard <- paste0("art", sample(1:100, 20))
analyzer <- SearchAnalyzer$new(
search_results = search_data,
gold_standard = gold_standard
)
analyzer
# Load required packages
library(searchAnalyzeR)
library(rentrez)  # For PubMed API access
library(xml2)     # For XML parsing
library(dplyr)
library(ggplot2)
library(lubridate)
library(patchwork)  # For combining plots
# Set up the comparative analysis
cat("=== searchAnalyzeR: Search Strategy Comparison Example ===\n")
cat("Topic: Long-term effects of COVID-19 (Long COVID)\n")
cat("Objective: Compare two semantically related search strategies\n\n")
# Define two different search strategies for comparison
strategy_A <- list(
name = "Clinical Terminology Strategy",
terms = c(
"post-covid syndrome",
"covid-19 sequelae",
"post-acute covid-19",
"long haul covid",
"covid long haulers"
),
description = "Uses formal clinical terminology and established medical terms",
databases = c("PubMed"),
date_range = as.Date(c("2020-01-01", "2024-12-31")),
filters = list(
language = "English",
article_types = c("Journal Article", "Review", "Clinical Trial")
),
search_date = Sys.time()
)
strategy_B <- list(
name = "Patient/Symptom-Focused Strategy",
terms = c(
"long covid",
"persistent covid symptoms",
"chronic covid symptoms",
"post covid fatigue",
"covid recovery complications"
),
description = "Uses patient-centered language and symptom-based terminology",
databases = c("PubMed"),
date_range = as.Date(c("2020-01-01", "2024-12-31")),
filters = list(
language = "English",
article_types = c("Journal Article", "Review", "Clinical Trial")
),
search_date = Sys.time()
)
cat("Strategy A (Clinical Terminology):\n")
cat("Terms:", paste(strategy_A$terms, collapse = " OR "), "\n")
cat("Description:", strategy_A$description, "\n\n")
cat("Strategy B (Patient/Symptom-Focused):\n")
cat("Terms:", paste(strategy_B$terms, collapse = " OR "), "\n")
cat("Description:", strategy_B$description, "\n\n")
# Execute searches for both strategies
cat("=== EXECUTING STRATEGY A: Clinical Terminology ===\n")
results_A <- search_pubmed(
search_terms = strategy_A$terms,
max_results = 150,
date_range = strategy_A$date_range
)
cat("\nStrategy A completed. Retrieved", nrow(results_A), "articles.\n\n")
cat("=== EXECUTING STRATEGY B: Patient/Symptom-Focused ===\n")
results_B <- search_pubmed(
search_terms = strategy_B$terms,
max_results = 150,
date_range = strategy_B$date_range
)
cat("\nStrategy B completed. Retrieved", nrow(results_B), "articles.\n\n")
# Standardize both result sets
cat("Standardizing search results...\n")
standardized_A <- std_search_results(results_A, source_format = "pubmed")
standardized_B <- std_search_results(results_B, source_format = "pubmed")
# Add strategy identifiers
standardized_A$strategy <- "Clinical_Terminology"
standardized_B$strategy <- "Patient_Symptom_Focused"
# Detect duplicates within each strategy
dedup_A <- detect_dupes(standardized_A, method = "exact")
dedup_B <- detect_dupes(standardized_B, method = "exact")
cat("Strategy A - Total:", nrow(dedup_A), "Unique:", sum(!dedup_A$duplicate), "Duplicates:", sum(dedup_A$duplicate), "\n")
cat("Strategy B - Total:", nrow(dedup_B), "Unique:", sum(!dedup_B$duplicate), "Duplicates:", sum(dedup_B$duplicate), "\n\n")
# Create combined gold standard for comparison
# In practice, this would be your known relevant articles
# Here we'll create a more sophisticated gold standard based on high-confidence matches
cat("Creating enhanced gold standard...\n")
# High-confidence terms that indicate long COVID relevance
high_confidence_patterns <- c(
"long covid", "post-covid", "post-acute covid", "persistent covid",
"covid sequelae", "long haul", "chronic covid", "post covid syndrome"
)
# Articles that appear in both strategies (high confidence)
overlap_ids <- intersect(dedup_A$id[!dedup_A$duplicate], dedup_B$id[!dedup_B$duplicate])
# Articles with multiple high-confidence patterns in title
multi_pattern_A <- dedup_A[!dedup_A$duplicate, ] %>%
filter(rowSums(sapply(high_confidence_patterns, function(p) grepl(p, tolower(title)))) >= 2) %>%
pull(id)
multi_pattern_B <- dedup_B[!dedup_B$duplicate, ] %>%
filter(rowSums(sapply(high_confidence_patterns, function(p) grepl(p, tolower(title)))) >= 2) %>%
pull(id)
# Combine for gold standard
gold_standard_ids <- unique(c(overlap_ids, multi_pattern_A, multi_pattern_B))
cat("Gold standard created with", length(gold_standard_ids), "high-confidence relevant articles\n")
cat("- Overlap between strategies:", length(overlap_ids), "articles\n")
cat("- Strategy A multi-pattern matches:", length(multi_pattern_A), "articles\n")
cat("- Strategy B multi-pattern matches:", length(multi_pattern_B), "articles\n\n")
# Initialize analyzers for both strategies
cat("Initializing SearchAnalyzers for comparison...\n")
analyzer_A <- SearchAnalyzer$new(
search_results = filter(dedup_A, !duplicate),
gold_standard = gold_standard_ids,
search_strategy = strategy_A
)
analyzer_B <- SearchAnalyzer$new(
search_results = filter(dedup_B, !duplicate),
gold_standard = gold_standard_ids,
search_strategy = strategy_B
)
# Calculate comprehensive metrics for both strategies
cat("Calculating performance metrics...\n")
metrics_A <- analyzer_A$calculate_metrics()
metrics_B <- analyzer_B$calculate_metrics()
# Compare strategies using the comparison framework
cat("Performing statistical comparison...\n")
unique_A_ids <- filter(dedup_A, !duplicate)$id
unique_B_ids <- filter(dedup_B, !duplicate)$id
comparison_result <- compare_strategies(
strategy1_results = unique_A_ids,
strategy2_results = unique_B_ids,
gold_standard = gold_standard_ids,
test_type = "mcnemar"
)
# Display comprehensive comparison results
cat("\n=== COMPREHENSIVE STRATEGY COMPARISON RESULTS ===\n\n")
cat("STRATEGY A (Clinical Terminology) PERFORMANCE:\n")
cat("Total Articles Retrieved:", nrow(filter(dedup_A, !duplicate)), "\n")
if (!is.null(metrics_A$precision_recall$precision)) {
cat("Precision:", round(metrics_A$precision_recall$precision, 3), "\n")
cat("Recall:", round(metrics_A$precision_recall$recall, 3), "\n")
cat("F1 Score:", round(metrics_A$precision_recall$f1_score, 3), "\n")
cat("Number Needed to Read:", round(metrics_A$precision_recall$number_needed_to_read, 1), "\n")
}
cat("\nSTRATEGY B (Patient/Symptom-Focused) PERFORMANCE:\n")
cat("Total Articles Retrieved:", nrow(filter(dedup_B, !duplicate)), "\n")
if (!is.null(metrics_B$precision_recall$precision)) {
cat("Precision:", round(metrics_B$precision_recall$precision, 3), "\n")
cat("Recall:", round(metrics_B$precision_recall$recall, 3), "\n")
cat("F1 Score:", round(metrics_B$precision_recall$f1_score, 3), "\n")
cat("Number Needed to Read:", round(metrics_B$precision_recall$number_needed_to_read, 1), "\n")
}
cat("\nSTATISTICAL COMPARISON RESULTS:\n")
cat("Test Used:", comparison_result$test, "\n")
cat("P-value:", round(comparison_result$p_value, 4), "\n")
cat("Statistically Significant:", comparison_result$significant, "\n")
if (!is.null(comparison_result$difference)) {
cat("\nPERFORMANCE DIFFERENCES (B - A):\n")
cat("Precision Difference:", round(comparison_result$difference$precision_diff, 3), "\n")
cat("Recall Difference:", round(comparison_result$difference$recall_diff, 3), "\n")
cat("F1 Score Difference:", round(comparison_result$difference$f1_diff, 3), "\n")
}
# Analyze overlap and unique contributions
cat("\nOVERLAP ANALYSIS:\n")
total_unique_combined <- length(union(unique_A_ids, unique_B_ids))
overlap_count <- length(intersect(unique_A_ids, unique_B_ids))
unique_to_A <- length(setdiff(unique_A_ids, unique_B_ids))
unique_to_B <- length(setdiff(unique_B_ids, unique_A_ids))
cat("Total Unique Articles (Combined):", total_unique_combined, "\n")
cat("Overlap Between Strategies:", overlap_count, "\n")
cat("Unique to Strategy A:", unique_to_A, "\n")
cat("Unique to Strategy B:", unique_to_B, "\n")
cat("Overlap Percentage:", round((overlap_count / total_unique_combined) * 100, 1), "%\n")
# Create enhanced visualizations for comparison
cat("\nGenerating comparative visualizations...\n")
# 1. Side-by-side performance overview
overview_A <- analyzer_A$visualize_performance("overview") +
ggtitle("Strategy A: Clinical Terminology") +
theme(plot.title = element_text(size = 12))
overview_B <- analyzer_B$visualize_performance("overview") +
ggtitle("Strategy B: Patient/Symptom-Focused") +
theme(plot.title = element_text(size = 12))
combined_overview <- overview_A + overview_B +
plot_annotation(title = "Search Strategy Performance Comparison",
subtitle = "Long COVID Search Strategies")
print(combined_overview)
# 2. Temporal comparison
temporal_A <- analyzer_A$visualize_performance("temporal") +
ggtitle("Strategy A: Temporal Distribution") +
theme(plot.title = element_text(size = 12))
temporal_B <- analyzer_B$visualize_performance("temporal") +
ggtitle("Strategy B: Temporal Distribution") +
theme(plot.title = element_text(size = 12))
combined_temporal <- temporal_A + temporal_B +
plot_annotation(title = "Temporal Distribution Comparison")
print(combined_temporal)
